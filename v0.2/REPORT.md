# Report (v0.2)

## 感染症シミュレーションプログラム

### 概要

本プログラムは、仮想的な合成人口データを用いて、感染症の拡大プロセスをシミュレートするものです。個人の属性（年齢、性別）、世帯構成、所属組織（学校や会社）といった社会的な構造に加え、個人の時間ごとの行動スケジュールを考慮し、感染がどのように広がるかをモデル化します。シミュレーションは1時間単位で進行し、より現実に近い接触パターンを再現します。

### 実装の詳細 (v0.2での主な変更点)

#### 1. 時間単位のシミュレーション

シミュレーションの基本単位を「日」から「時間」に変更しました。これにより、1日の中での人々の移動や接触の変化を細かく追跡できます。シミュレーションは `SIM_DAYS` で指定された日数分、24時間単位で実行されます。

#### 2. 個人のスケジュールと場所のモデル化

*   **`Person.schedule`**: 各個人に、1時間ごとの行動を定義した「スケジュール」を持たせました。これにより、「朝夕の通勤」「日中の勤務・就学」「夜の繁華街への外出」といった行動をモデル化しています。
*   **場所 (`Place`)**: 世帯(`Family`)や組織(`Organization`)に加え、「通勤電車(`train`)」や「繁華街(`downtown`)」といった公共の場所を導入しました。これらの場所は、時間帯によって異なる人々が利用する動的な集団を形成します。
*   **感染ロジック**: 感染は、各個人がその時間に滞在している「場所」で発生します。同じ場所にいる感染者から感受性者へ、場所ごとに設定された感染確率に基づいて伝播します。

#### 3. 詳細な組織構造

*   **学校のクラス分け**: v0.1では単一の「学校」組織でしたが、v0.2では最大30人の「クラス」に分割しました。これにより、学校内での感染がより現実的な小集団の中で発生するようになりました。
*   **会社の規模**: 会社組織の人数は、引き続きポアソン分布に従ってランダムに決定されます。

#### 4. 主要なクラスの更新

*   **`Person`**: `schedule`（時間ごとのスケジュール）、`current_place`（現在の場所）、`infection_hour`（感染時間）などの属性が追加されました。
*   **`Organization`**: 学校のクラス、会社、公共交通機関など、様々な場所を表現する汎用的なクラスとなりました。それぞれに異なる内部感染確率が設定されています。
*   **`Simulation`**: `run_hourly_step` メソッドで1時間ごとのシミュレーションを実行するようにロジックが全面的に刷新されました。日々の結果は `log_daily_history` で記録されます。

### 実行と結果

`population-1000.csv` を用い、100日間のシミュレーションを実行しました。時間単位の行動モデルを導入したことで、特定の時間帯（例：通勤ラッシュ）や場所（例：学校のクラス）が感染拡大のホットスポットになる様子がシミュレートされます。

実行後、`simulation_plot.png` というファイル名で、感受性者(S)、感染者(I)、回復者(R)、死亡者(D)の推移をプロットしたグラフが自動的に保存されます。

### Stanによる分析

シミュレーションの実行後、結果として得られた日次の感染者数（I）の推移データを`CmdStanPy`に渡し、SIRモデルによるパラメータ推定を行いました。

*   **モデル**: `sir.stan`に定義された常微分方程式（ODE）ベースのSIRモデルを使用しました。
*   **推定**: ベイズ推定により、基本再生産数（R0）、感染率（beta）、回復率（gamma）などの主要なパラメータを事後分布として求めました。
*   **結果**:
    *   `stan_trace.png`: パラメータのトレースプロットが保存され、サンプリングが収束しているか視覚的に確認できます。
    *   `rt_plot.png`: 推定された実効再生産数（R(t)）の時系列プロットが保存されます。これにより、シミュレーション期間中の感染の勢いの変化を評価できます。
    *   コンソールには、`beta`, `gamma`, `R0`の平均値、標準偏差、信用区間を含む要約統計量が出力されます。

この分析により、複雑なエージェントベースのシミュレーション結果を、疫学の標準的な指標（R0やR(t)）と関連付けて解釈することが可能になります。

### 今後の課題と判断

*   **パラメータとスケジュールの精緻化**:
    *   各場所の感染確率や、個人のスケジュールパターンは、現在簡易的な設定です。より現実のデータ（例：交通調査、行動ログ）に基づいてこれらのパラメータを調整することで、シミュレーションの精度を高めることができます。
    *   主婦やリタイアした人々の行動モデルは現在実装されていないため、今後の拡張が望まれます。
*   **モデルの拡張**: 全校集会や、異なる会社間の会議など、スケジュールにないランダムな接触イベントを追加することも、より現実的なシミュレーションへの拡張として考えられます。
*   **Stanモデルとの適合性**: 現在のシミュレーションは自己隔離などの複雑な要素を含むため、単純なSIRモデルとは乖離が見られる場合があります。Stanの実行時に発散（divergent transitions）が警告される場合、シミュレーションの動態が単純なSIRモデルの仮定から外れていることを示唆しており、それ自体が分析上の知見となります。


---
*この文書はGeminiによって生成されました。*